# 第六章：安全篇 —— 容灾与加密 (Rclone 实战版)

> **摘要**：NAS 坏了可以修，硬盘坏了可以买，但数据丢了就是永久的痛。本章将带你构建符合工业标准的 **“3-2-1” 备份体系**。我们将利用神器 **Rclone**，把你的 NAS 变成一个自动化的加密堡垒。
>
> **核心目标**：通过 Rclone 的 Crypt 模块实现**本地/云端双重加密**，并利用 Crontab 实现**凌晨无人值守的增量冷备份**。

---

## 6.1 核心防线：Rclone Crypt 加密 (数据黑箱)

为什么我们不敢把照片传到公有云？因为怕被扫描，怕隐私泄露，怕数据被删。
**Rclone** 是 NAS 界的瑞士军刀，而它的 **Crypt (加密)** 模块则是解决这个问题的终极杀器。它能在一个普通的存储位置（如阿里云盘文件夹）之上，包裹一层高强度的加密壳。

* **原理**：上传前在本地加密 -> 传输乱码 -> 云端存储乱码。
* **结果**：云厂商只能看到一堆名为 `8s7d9f.bin` 的文件，完全不知道里面是你女儿的照片还是公司的账目。

### 6.1.1 第一步：部署协议网关 —— Alist

由于阿里云盘、115网盘等国内服务商的 API 经常变动，Rclone 直接连接容易失效。我们需要 **Alist** 作为中间件，将各种各样的网盘统一转换成标准的 **WebDAV** 协议。

#### 阶段一：安装 Alist (二选一)

**方案 A：飞牛 (fnOS) 应用中心安装**

1. 打开飞牛桌面 -> **应用中心**。
2. 搜索 **"AList"**，点击安装。
3. 安装完成后点击 **打开**，即可跳转至网页后台。
   *(注：应用中心版通常会提示初始账号密码，或默认为 admin/admin)*

**方案 B：通用 Docker 命令行部署**
如果你的系统没有应用中心，或者习惯使用 Docker 命令行，请参考以下步骤：

1. **拉取镜像并运行**：

    ```bash
    docker run -d \
      --restart=always \
      -v /etc/alist:/opt/alist/data \
      -p 5244:5244 \
      -e PUID=0 -e PGID=0 \
      -e UMASK=022 \
      --name alist \
      xhofe/alist:latest
    ```

2. **获取初始密码 (Docker 必做)**：
    容器启动后，必须查看日志才能拿到随机生成的密码：

    ```bash
    docker logs alist
    ```

    *在日志中寻找 `Successfully created user admin with password: ...` 这一行。*

---

#### 阶段二：初始化配置 (通用步骤) ⚙️

无论你是用哪种方式安装的，都需要进行以下配置来挂载云端存储。

1. **登录后台**：
    浏览器访问 `http://NAS-IP:5244`，输入账号密码登录。

2. **添加存储 (Mount Storage)**：
    * 点击左侧菜单 **存储 (Storages)** -> **添加 (Add)**。
    * **驱动 (Driver)**：选择 **阿里云盘 Open** (推荐) 或其他网盘。

3. **核心参数设置 ⚠️**：
    * **挂载路径 (Mount Path)**：填写 `/aliyun`
        * **注意**：这是后续所有自动化脚本识别网盘的“暗号”，**后续需要使用到该目录**。
    * **刷新令牌 (Refresh Token)**：
        * 阿里云盘 Open：使用 App 扫码获取 (参考 [Alist 官方文档](https://alist.nn.ci/zh/guide/drivers/aliyundrive_open.html))。
        * 其他网盘：请查阅 Alist 文档获取对应 Token。

4. **验证状态**：
    保存后，如果在存储列表中看到状态为绿色的 **Work**，说明 NAS 已经成功接管了你的云端硬盘。

### 6.1.2 第二步：安装搬运工 —— Rclone  🛠️

大多数 NAS 系统（fnOS/群晖/Unraid）本质都是 Linux。虽然它们有图形界面，但 Rclone 最好用命令行安装。

**1. 检查 CPU 架构 (这一步很重要)**
输入 `uname -m` 查看架构：

* 如果显示 `x86_64` -> 下载 **amd64** 版本 (绝大多数 NAS 都是这个)。
* 如果显示 `aarch64` -> 下载 **arm64** 版本 (树莓派等)。

**2. 执行下载与安装 (以 amd64 为例)**
请依次复制执行以下命令：

```bash
# 1. 进入临时目录
cd /tmp

# 2. 下载 Rclone 压缩包 (版本 v1.72.0 amd64 为例)
wget https://github.com/rclone/rclone/releases/download/v1.72.0/rclone-v1.72.0-linux-amd64.zip

# 3. 解压文件
unzip rclone-v1.72.0-linux-amd64.zip

# 4. 进入解压后的文件夹
cd rclone-v1.72.0-linux-amd64

# 5. 安装：将二进制文件移动到系统目录
sudo cp rclone /usr/bin/

# 6. 赋予权限：设置所有者为 root 并赋予可执行权限
sudo chown root:root /usr/bin/rclone
sudo chmod 755 /usr/bin/rclone

# 7. 验证安装
rclone version
```

> 如果你看到类似 `rclone v1.72.0` 的输出，说明安装成功！

### 6.1.3 第三步：配置基础连接 (Base Remote)

现在我们要让 Rclone 连上刚才搭建的 Alist。

1. **进入配置向导**：
    输入命令：`rclone config`
2. **新建连接**：
    输入 `n` (New remote)。
3. **命名基础盘**：
    输入名称：`aliyun_raw` (后缀 raw 代表这是未加密的原始盘)。
4. **选择协议**：
    系统会列出一大堆协议，找到 **WebDAV** (通常输入 `59` 或搜索 `webdav`)。
5. **输入地址 (URL)**：
    `http://192.168.x.x:5244/dav`(替换为你 NAS 的 IP)
6. **选择代理类型**：
    选择 `Other` (或者 `4`，代表通用 WebDAV)。
7. **输入账号密码**：
    输入你刚才登录 **Alist 网页后台** 的账号（通常是 `admin`）和密码。
8. **测试连接**：
    一路回车默认，最后输入 `q` 退出。
    测试命令：`rclone lsd aliyun_raw:` (注意后面有个冒号)，如果能列出你在 Alist 里挂载的 `/aliyun` 目录，说明打通了。

### 6.1.4 第四步：配置加密层 (Crypt Remote) 🛡️

这是最关键的一步，我们要给 `aliyun_raw` 穿上一层防弹衣。

1. **新建加密连接**：
    在 `rclone config` 主菜单继续输入 `n`。
2. **命名加密盘**：
    输入名称：`aliyun_secret` (这个名字才是你以后备份脚本里要用的)。
3. **选择类型**：
    找到 **Encrypt/Decrypt a remote** (通常搜索 `crypt`，输入对应数字)。
4. **关键设置 (套娃时刻) ⚠️**：
    * **Remote to encrypt (被加密的路径)**：
        输入 `aliyun_raw:/aliyun/Backup`
        *(解释：这表示把加密文件存在 `aliyun_raw` 这个连接下的 `/aliyun` 目录下的 `Backup` 文件夹里)*
    * **Filename encryption (文件名加密)**：
        选择 `standard` (强烈建议！连文件名都加密成乱码，防止通过文件名猜测内容)。
    * **Directory name encryption (目录名加密)**：
        选择 `true` (文件夹名也加密)。
5. **设置密码 (生死攸关 🚨)**：
    * **Password 1**: 设置一个强密码。
    * **Password 2 (Salt/盐)**: 设置第二个强密码。
    * **警告**：**请务必把这两个密码打印出来或者写在纸上，放进保险柜！** Rclone 的加密是 AES-256 级别的，如果你忘了密码，就算上帝也打不开这些文件。

### 6.1.5 验证加密效果

配置完成后，我们来做一次“实弹演练”。

1. **创建一个测试文件**：

    ```bash
    echo "Hello NAS" > test.txt
    ```

2. **上传到加密盘**：

    ```bash
    rclone copy test.txt aliyun_secret:/
    ```

3. **见证奇迹**：
    我们要看看在“原始盘”里，这个文件变成了什么样。

    ```bash
    rclone ls aliyun_raw:/aliyun/Backup
    ```

    * **预期输出**：你应该看不到 `test.txt`，只能看到类似 `15 9k2d8s72j3h4/8s7d9f2k3j4l.bin` 的乱码文件。
    * 这意味着：**加密成功！** 以后所有通过 `aliyun_secret` 写入的数据，在网盘端全是乱码。

---

## 6.2 自动化：编写 Crontab 定时脚本

我们不需要人工每天去点“上传”，一切交给 Linux 的定时任务。

### 6.2.1 部署自动备份脚本

为了简化部署，我们已经为您准备好了一个生产级的备份脚本。您可以在本项目代码库中直接查看或下载：
👉 **脚本文件**：[`scripts/rclone_autobackup.sh`](../scripts/rclone_autobackup.sh)

**1. 安装脚本**
将项目中的 [`scripts/rclone_autobackup.sh`](../scripts/rclone_autobackup.sh) 文件上传至 NAS 的 `/root/scripts/` 目录。

**2. 核心配置修改 (必读)**
打开脚本，您只需要修改脚本顶部的 **配置区** 即可适应您的环境：

```bash
# ================= 您的配置区 =================

# 1. 定义要备份的本地目录列表 (数组格式)
# 脚本会自动提取文件夹名称并在网盘建立同名目录
# 例如："/vol1/1000/Photos" -> 备份到网盘的 "Photos" 文件夹
SOURCE_DIRS=(
    "/vol1/1000/mje"
    "/vol1/1000/Photos"
    "/vol1/1002"
)

# 2. 远程目标根目录
# 请修改为您在 rclone config 中配置的加密盘名称
DEST_ROOT="aliyun_secret:/"

# 3. 日志文件路径
LOG_FILE="/home/admin/rclone_daily.log"

# 4. 锁文件路径 (用于防止脚本重叠运行)
LOCK_FILE="/tmp/rclone_autobackup.lock"
```

**3. 运行参数深度解析**
脚本中预设了一组针对国内网络环境深度优化的 `rclone` 运行参数，以下是它们的作用：

### 🛡️ 运行保护机制

* **文件锁 (flock)**：脚本启动时会尝试获取指定的锁文件。如果上一次备份任务尚未结束（例如大文件正在传输），本次任务会**自动跳过**，并在日志中记录警告信息。这有效防止了多个进程争抢带宽导致的系统卡顿。
* **原子化操作**：通过文件描述符锁定，即使脚本意外崩溃，系统也会自动释放锁，确保下次定时任务能正常启动。

### 🔄 备份与清理策略

* **双重同步逻辑**：
    1. **扫描清理 (`rclone check`)**：脚本会先对比本地与云端的差异。如果云端存在本地已删除、或大小不一致的“残留文件”，脚本会先将其**精准剔除**。
    2. **增量上传 (`rclone copy`)**：清理完成后执行上传，仅补传新增或改动的文件。
* **`--size-only`**：**核心提速参数**。由于跨系统传输（如 NAS 到网盘）时文件修改时间经常无法精确匹配，开启此项后，脚本**仅对比文件大小**。这能让海量小文件的扫描比对速度提升 10 倍以上。

### ⚡ 性能与稳定性控制

* **并发控制**：
  * `--transfers 2`：限制同时上传的文件数为 2。
  * `--checkers 4`：限制同时扫描检查的文件数为 4。
  * *注：这种低并发设置是为了确保在备份时，家庭其他成员上网不会感到明显卡顿。*
* **内存优化 (`--buffer-size 32M`)**：在内存中开辟缓冲区，减少对硬盘的频繁随机读取，延长硬盘寿命。
* **超时与重试**：
  * `--timeout 10h`：针对超大文件给予充足的传输时间。
  * `--retries 3`：针对不稳定的 API 自动进行重试，确保任务高成功率。

### 🚫 过滤规则

* 自动排除系统冗余文件，保持云端干净：
  * `__MACOSX/` 与 `._*` (Mac 预览缓存)
  * `.DS_Store` (文件夹自定义属性)
  * `*.torrent` (种子文件)

**4. 赋予执行权限**

```bash
chmod +x /root/scripts/rclone_autobackup.sh
```

### 6.2.2 设置 Crontab 定时任务

输入 `crontab -e`，添加以下一行：

```cron
# 每天凌晨 3:00 执行备份脚本
0 3 * * * /bin/bash /root/scripts/reclone_autobackup.sh
```

---

## 6.3 灾难恢复演练 (Restore)

**没有经过恢复测试的备份，都是“薛定谔的备份”。**

1. **场景**：NAS 硬盘全毁，你换了新硬盘，重装了系统。
2. **恢复步骤**：
    * 安装 Rclone。
    * **关键**：找出你打印在纸上的 `aliyun_secret` 的密码和 Salt，重新配置 Config。
    * 执行恢复命令：

        ```bash
        # 把云端加密的数据，解密下载到本地
        rclone copy aliyun_secret:/ /vol1/1000/Photos_Restored
        ```

    * 检查下载回来的文件，如果能正常打开，恭喜你，你的容灾体系**合格了**。

---

## ✅ 本章小结

通过本章的配置，你已经获得了一个工业级的备份系统：

* **隐私无忧**：Rclone Crypt 确保了即使马云或微软的管理员也无法偷看你的照片。
* **自动化**：Crontab 确保了备份在每天凌晨当你熟睡时自动完成。
* **多地容灾**：即使家里发生火灾，珍贵的回忆依然躺在云端的服务器里安然无恙。
